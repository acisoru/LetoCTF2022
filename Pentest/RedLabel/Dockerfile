FROM ubuntu:16.04

LABEL maintainer="by_sm" email='by.sm@protonmail.com' description="example vulnerable machine"

RUN  export DEBIAN_FRONTEND=noninteractive
ENV  DEBIAN_FRONTEND noninteractive
RUN  dpkg-divert --local --rename --add /sbin/initctl
RUN apt update
RUN apt-get -y install ca-certificates openssh-server supervisor rpl openssh-client
COPY ./src/supervisord.conf /etc/supervisor.conf

#ssh
RUN mkdir /var/run/sshd
COPY ./src/sshd.conf /etc/supervisor/conf.d/sshd.conf
RUN rpl "PermitRootLogin without-password" "PermitRootLogin yes" /etc/ssh/sshd_config
RUN sed -i "s/.*PasswordAuthentication.*/PasswordAuthentication no/g" /etc/ssh/sshd_config

#depends
RUN \
  apt-get update && \
  apt-get -y upgrade && \
  apt-get install -y libc6 g++ libc-dev manpages-dev libc-dev-bin sudo && \
  apt-get install -y build-essential && \
  apt-get install -y software-properties-common && \
  apt-get install -y curl htop man wget && \
  apt-get install -y apache2 && \
  rm -rf /var/lib/apt/lists/* 

#add file to apache
COPY ./src/index.html /var/www/html/index.html
COPY ./src/1.jpg /var/www/html/1.jpg

#journalctl fix
RUN apt update && apt install -y upstart syslog-ng
RUN mkdir /run/log/journal
COPY ./src/test.journal /run/log/journal/test.journal

# Install Redis.
RUN \
  cd /tmp && \
  wget http://download.redis.io/redis-stable.tar.gz && \
  tar xvzf redis-stable.tar.gz && \
  cd redis-stable && \
  make && \
  make install && \
  cp -f src/redis-sentinel /usr/local/bin && \
  mkdir -p /etc/redis && \
  rm -rf /tmp/redis-stable*
COPY ./src/redis.conf /etc/redis/redis.conf
RUN mkdir /var/lib/redis/
RUN mkdir /var/lib/redis/.ssh
RUN useradd redis -m -d /var/lib/redis
RUN chown -R redis.redis /var/lib/redis/
COPY ./src/redis_server.conf /etc/supervisor/conf.d/redis_server.conf

#User
RUN useradd test -G sudo -m
RUN echo test:qwerty123 | chpasswd
RUN mkdir /home/test/monitoring
COPY ./src/run.sh /home/test/monitoring/run.sh
RUN chmod og-rwx /home/test/monitoring/run.sh
RUN chown test.test /home/test/monitoring/run.sh
USER test
RUN ssh-keygen -q -t rsa -N 'pokemon' -f /home/test/.ssh/id_rsa
RUN cp /home/test/.ssh/id_rsa.pub /home/test/.ssh/authorized_keys
RUN cp /home/test/.ssh/id_rsa /tmp/id_rsa.bak
RUN chmod +r /tmp/id_rsa.bak

USER root
RUN echo "test ALL=(ALL:ALL) NOPASSWD:/bin/journalctl -n15" > /etc/sudoers

#create token
RUN echo "LetoCTF{RedLabel_us3r_easy}" > /home/test/user.txt
RUN chown -R test.test /home/test/user.txt
RUN chmod og-rwx /home/test/user.txt
RUN chmod -w /home/test/user.txt
RUN echo "LetoCTF{3asy_s0_3asy_RedLabel}" > /root/root.txt

#start
CMD ["supervisord", "-c", "/etc/supervisor.conf"]
