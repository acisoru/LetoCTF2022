FROM ubuntu

RUN apt update && apt install -y openssh-server supervisor python3 python3-pip nasm gcc screen supervisor

RUN /usr/bin/ssh-keygen -A
RUN echo 'root:roottoor' | chpasswd
RUN sed -i -e 's/^UsePAM yes/UsePAM no/g' /etc/ssh/sshd_config
RUN python3 -m pip install pypiserver
RUN mkdir /root/packages
RUN ln -sf /dev/null /root/.bash_history
RUN ssh-keygen -q -t rsa -f /root/.ssh/id_rsa
RUN touch /root/.ssh/authorized_keys
ADD ./src/supervisor.conf /etc/supervisor.conf
RUN useradd server -G sudo -m
RUN echo server:JVkveGJ527zL6F5G | chpasswd
RUN python3 -m pip install flask pypiserver

USER server
RUN ssh-keygen -q -t rsa -f /home/server/.ssh/id_rsa
ADD ./app /home/server/app

USER root
CMD ["supervisord", "-c", "/etc/supervisor.conf"]
